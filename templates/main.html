<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WARHAMMER - {{ warhammer_name }}</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='logo/favicon.svg') }}">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% if mapbox_token %}
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <style>
        .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib { display: none !important; }
    </style>
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo-icon">
                    <svg width="28" height="28" viewBox="0 0 100 100" fill="none">
                        <rect x="20" y="15" width="60" height="25" rx="3" fill="url(#hg)" stroke="#ff6b35" stroke-width="2"/>
                        <rect x="45" y="40" width="10" height="50" rx="2" fill="#3a2a1a" stroke="#ff6b35" stroke-width="1.5"/>
                        <defs><linearGradient id="hg" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff8c42"/><stop offset="100%" style="stop-color:#cc3700"/>
                        </linearGradient></defs>
                    </svg>
                </div>
                <span class="logo-text">WARHAMMER</span>
                <span class="header-divider">|</span>
                <div class="status-indicator" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">CONNECTING</span>
                </div>
                <div class="activity-indicator" id="activityIndicator">
                    <div class="radar-sweep"></div>
                    <div class="radar-ping"></div>
                </div>
            </div>

            <div class="header-center">
                <div class="system-info">
                    <span class="info-label">HOST:</span>
                    <span class="info-value">{{ warhammer_name }}</span>
                </div>
                <div class="system-info">
                    <span class="info-label">PEERS:</span>
                    <span class="info-value peer-count" id="peerCount">0</span>
                </div>
            </div>

            <div class="header-right">
                <!-- Cellular Signal Indicator -->
                <div class="cellular-indicator hidden" id="cellularIndicator">
                    <div class="signal-bars">
                        <div class="signal-bar" id="bar1"></div>
                        <div class="signal-bar" id="bar2"></div>
                        <div class="signal-bar" id="bar3"></div>
                        <div class="signal-bar" id="bar4"></div>
                    </div>
                    <span class="cellular-tech" id="cellularTech"></span>
                    <!-- Cellular Status Popup -->
                    <div class="cellular-popup" id="cellularPopup">
                        <div class="cellular-popup-title">CELLULAR STATUS</div>
                        <div class="cellular-popup-row">
                            <span class="label">Operator:</span>
                            <span class="value" id="cellOperator">--</span>
                        </div>
                        <div class="cellular-popup-row">
                            <span class="label">Technology:</span>
                            <span class="value" id="cellTechnology">--</span>
                        </div>
                        <div class="cellular-popup-row">
                            <span class="label">Signal:</span>
                            <span class="value" id="cellSignal">--</span>
                        </div>
                        <div class="cellular-popup-row">
                            <span class="label">RSSI:</span>
                            <span class="value" id="cellRSSI">--</span>
                        </div>
                        <div class="cellular-popup-row">
                            <span class="label">Phone:</span>
                            <span class="value" id="cellPhone">--</span>
                        </div>
                        <div class="cellular-popup-row">
                            <span class="label">IMEI:</span>
                            <span class="value" id="cellIMEI">--</span>
                        </div>
                        <div class="cellular-popup-row">
                            <span class="label">ICCID:</span>
                            <span class="value" id="cellICCID">--</span>
                        </div>
                        <div class="cellular-popup-row">
                            <span class="label">State:</span>
                            <span class="value" id="cellState">--</span>
                        </div>
                    </div>
                </div>
                <div class="operator-info">
                    <span class="info-label">OPERATOR:</span>
                    <span class="info-value">{{ username | upper }}</span>
                </div>
                <button class="settings-btn" onclick="openSettingsModal()">&#9881;</button>
                <a href="{{ url_for('logout') }}" class="logout-btn">LOGOUT</a>
            </div>
        </header>

        <!-- Operations Bar -->
        <div class="operations-bar">
            <span class="ops-label">NETWORK:</span>
            <span class="ops-domain" id="warhammerDomain">{{ warhammer_domain }}</span>
            <span class="ops-separator">|</span>
            <span class="ops-label">IP:</span>
            <span class="ops-ip" id="managementIP">{{ management_ip }}</span>
            <span class="ops-separator">|</span>
            <span class="ops-label">UPTIME:</span>
            <span class="ops-uptime" id="systemUptime">--</span>
            <span class="ops-separator">|</span>
            <span class="ops-label">VERSION:</span>
            <span class="ops-version" id="opsVersion">{{ version }}</span>
            <span class="ops-separator">|</span>
            <div class="ops-subscription" id="opsSubscription" onclick="openSettingsModal(); showSettingsTab('subscription');">
                <span class="ops-label">LICENSE:</span>
                <span class="ops-subscription-status" id="opsSubscriptionStatus">--</span>
            </div>
        </div>

        <!-- Subscription Alert Banner (shown when subscription/token expiring) -->
        <div class="subscription-alert-banner hidden" id="subscriptionAlertBanner">
            <span class="alert-icon">&#9888;</span>
            <span class="alert-message" id="alertBannerMessage">Your subscription is expiring soon</span>
            <button class="alert-action" onclick="openSettingsModal(); showSettingsTab('subscription');">VIEW DETAILS</button>
            <button class="alert-dismiss" onclick="dismissAlertBanner()">&#10005;</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Outdated Peers Notification -->
            <div id="outdatedPeersNotification" class="hidden"></div>

            <!-- Left Panel - Network Status -->
            <div class="panel panel-left">
                <!-- System Status Section -->
                <div class="panel-section" id="systemStatusSection">
                    <div class="section-header collapsible" onclick="toggleSection('systemStatusSection')">
                        <span class="section-icon">&#128187;</span>
                        <span>SYSTEM STATUS</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="system-gauges">
                            <div class="gauge-item">
                                <div class="gauge-circle" id="cpuGauge">
                                    <svg viewBox="0 0 100 100">
                                        <circle class="gauge-bg" cx="50" cy="50" r="45"/>
                                        <circle class="gauge-fill" cx="50" cy="50" r="45" id="cpuGaugeFill"/>
                                    </svg>
                                    <div class="gauge-value" id="cpuGaugeValue">0%</div>
                                    <div class="gauge-label">CPU</div>
                                </div>
                            </div>
                            <div class="gauge-item">
                                <div class="gauge-circle" id="memGauge">
                                    <svg viewBox="0 0 100 100">
                                        <circle class="gauge-bg" cx="50" cy="50" r="45"/>
                                        <circle class="gauge-fill" cx="50" cy="50" r="45" id="memGaugeFill"/>
                                    </svg>
                                    <div class="gauge-value" id="memGaugeValue">0%</div>
                                    <div class="gauge-label">MEM</div>
                                </div>
                            </div>
                            <div class="gauge-item">
                                <div class="gauge-circle" id="diskGauge">
                                    <svg viewBox="0 0 100 100">
                                        <circle class="gauge-bg" cx="50" cy="50" r="45"/>
                                        <circle class="gauge-fill" cx="50" cy="50" r="45" id="diskGaugeFill"/>
                                    </svg>
                                    <div class="gauge-value" id="diskGaugeValue">0%</div>
                                    <div class="gauge-label">DISK</div>
                                </div>
                            </div>
                        </div>
                        <div class="temp-display" id="tempDisplay">
                            <span class="temp-icon">&#127777;</span>
                            <span class="temp-value" id="tempValue">--</span>
                        </div>
                    </div>
                </div>

                <!-- Network Interfaces Section -->
                <div class="panel-section" id="interfacesSection">
                    <div class="section-header collapsible" onclick="toggleSection('interfacesSection')">
                        <span class="section-icon">&#9783;</span>
                        <span>INTERFACES</span>
                        <span class="interface-count" id="interfaceCount">0</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content interface-list" id="interfaceList">
                        <!-- Interfaces populated by JS -->
                    </div>
                </div>

                <!-- Services Section -->
                <div class="panel-section" id="servicesSection">
                    <div class="section-header collapsible" onclick="toggleSection('servicesSection')">
                        <span class="section-icon">&#9881;</span>
                        <span>SERVICES</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content service-list" id="serviceList">
                        <!-- Services populated by JS -->
                    </div>
                </div>

                <!-- Plugins -->
                <div class="panel-section" id="pluginsSection">
                    <div class="section-header collapsible" onclick="toggleSection('pluginsSection')">
                        <span class="section-icon">&#128230;</span>
                        <span>PLUGINS</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="plugin-list" id="pluginList">
                            <!-- Plugins populated by JS -->
                        </div>
                        <button class="btn btn-primary btn-sm btn-block" onclick="showAddPluginModal()" style="margin-top: 10px;">
                            + ADD PLUGIN
                        </button>
                    </div>
                </div>

                <!-- System Controls -->
                <div class="panel-section" id="sbcSection">
                    <div class="section-header collapsible" onclick="toggleSection('sbcSection')">
                        <span class="section-icon">&#9211;</span>
                        <span>SYSTEM CONTROLS</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="sbc-info" id="sbcInfo">
                            <div class="sbc-model" id="sbcModel">WARHAMMER Node</div>
                            <div class="sbc-details" id="sbcDetails">Loading...</div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-warning btn-sm" onclick="confirmReboot()">
                                <span>&#8635;</span> REBOOT
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="confirmShutdown()">
                                <span>&#9211;</span> SHUTDOWN
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center - Main Dashboard -->
            <div class="center-content">
                <!-- Network Traffic Chart -->
                <div class="chart-panel">
                    <div class="chart-header">
                        <span class="chart-title">&#128200; NETWORK THROUGHPUT</span>
                        <div class="chart-legend">
                            <span class="legend-item rx"><span class="legend-color"></span>RX</span>
                            <span class="legend-item tx"><span class="legend-color"></span>TX</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="networkChart"></canvas>
                    </div>
                    <div class="chart-stats">
                        <div class="stat-box">
                            <span class="stat-value rx" id="rxRate">0 B/s</span>
                            <span class="stat-label">Download</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value tx" id="txRate">0 B/s</span>
                            <span class="stat-label">Upload</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value" id="totalRx">0 B</span>
                            <span class="stat-label">Total RX</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value" id="totalTx">0 B</span>
                            <span class="stat-label">Total TX</span>
                        </div>
                    </div>
                </div>

                <!-- Latency Monitor -->
                <div class="chart-panel latency-panel">
                    <div class="chart-header">
                        <span class="chart-title">&#128225; PEER LATENCY</span>
                        <button class="btn btn-sm" onclick="pingAllPeers()">&#8635; PING ALL</button>
                    </div>
                    <div class="chart-container chart-sm">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>

                <!-- Peer Map (if Mapbox token provided) -->
                {% if mapbox_token %}
                <div class="map-panel">
                    <div class="chart-header">
                        <span class="chart-title">&#127757; PEER LOCATIONS</span>
                        <div class="map-controls">
                            <button class="btn btn-sm btn-map" onclick="fitMapToPeers()">&#8982; FIT ALL</button>
                            <button class="btn btn-sm btn-map" onclick="centerMap()">&#127968; CENTER</button>
                        </div>
                    </div>
                    <div class="map-container" id="mapContainer"></div>
                </div>
                {% endif %}
            </div>

            <!-- Right Panel - Peers -->
            <div class="panel panel-right">
                <!-- WARHAMMER Network Status -->
                <div class="panel-section" id="networkStatusSection">
                    <div class="section-header">
                        <span class="section-icon">&#128279;</span>
                        <span>NETWORK STATUS</span>
                        <span class="warhammer-status" id="warhammerStatus">CHECKING</span>
                    </div>
                    <div class="section-content">
                        <div class="warhammer-info" id="warhammerInfo">
                            <div class="info-row">
                                <span class="info-label">Version:</span>
                                <span class="info-value" id="whVersion">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Public Key:</span>
                                <span class="info-value truncate" id="whPubKey">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Network ID:</span>
                                <span class="info-value truncate" id="whNetworkId">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Peers List -->
                <div class="panel-section peers-section" id="peersSection">
                    <div class="section-header collapsible" onclick="toggleSection('peersSection')">
                        <span class="section-icon">&#128101;</span>
                        <span>NETWORK PEERS</span>
                        <span class="device-counter" id="peerCounter">0</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="peer-toolbar">
                        <input type="text" class="peer-search" id="peerSearch" placeholder="Search peers..." oninput="filterPeers()">
                        <button class="btn btn-sm" onclick="toggleCoordinateFormat()" title="Toggle MGRS/Lat-Lon">&#127760;</button>
                        <button class="btn btn-sm" onclick="refreshPeers()">&#8635;</button>
                    </div>
                    <div class="peer-list" id="peerList">
                        <!-- Peers populated by JS -->
                    </div>
                </div>

                <!-- Routes -->
                <div class="panel-section" id="routesSection">
                    <div class="section-header collapsible" onclick="toggleSection('routesSection')">
                        <span class="section-icon">&#128739;</span>
                        <span>ROUTES</span>
                        <span class="route-counter" id="routeCounter">0</span>
                        <span class="section-toggle">&#9660;</span>
                    </div>
                    <div class="section-content">
                        <div class="route-toolbar">
                            <button class="btn btn-sm btn-primary" onclick="openAddRouteModal()">+ ADD ROUTE</button>
                        </div>
                        <div class="route-list" id="routeList">
                            <!-- Routes populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="panel-section log-section" id="logSection">
                    <div class="section-header">
                        <span class="section-icon">&#128196;</span>
                        <span>ACTIVITY LOG</span>
                        <button class="btn btn-sm" onclick="clearLog()">CLEAR</button>
                    </div>
                    <div class="log-container" id="logContainer">
                        <!-- Logs populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <span>&#9881; SETTINGS</span>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="showSettingsTab('general')">General</button>
                    <button class="settings-tab" onclick="showSettingsTab('network')">Network</button>
                    <button class="settings-tab" onclick="showSettingsTab('display')">Display</button>
                    <button class="settings-tab" onclick="showSettingsTab('subscription')">Subscription</button>
                    <button class="settings-tab" onclick="showSettingsTab('about')">About</button>
                </div>

                <div id="settingsGeneral" class="settings-content active">
                    <div class="settings-group">
                        <h3>Refresh Intervals</h3>
                        <div class="setting-row">
                            <label>Metrics Update (ms):</label>
                            <input type="number" id="metricsInterval" class="input" value="2000" min="500" max="10000">
                        </div>
                        <div class="setting-row">
                            <label>Peers Refresh (ms):</label>
                            <input type="number" id="peersInterval" class="input" value="30000" min="5000" max="120000">
                        </div>
                    </div>
                </div>

                <div id="settingsNetwork" class="settings-content">
                    <div class="settings-group">
                        <h3>WARHAMMER Network</h3>
                        <div class="setting-row">
                            <label>Domain:</label>
                            <input type="text" id="settingsWhDomain" class="input" value="{{ warhammer_domain }}" readonly>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3>Cellular / APN Settings</h3>

                        <!-- Auto-Configure Section -->
                        <div class="apn-auto-config" id="apnAutoConfig">
                            <div class="auto-config-info" id="autoConfigInfo">
                                <span class="detecting">Detecting carrier...</span>
                            </div>
                            <button class="btn btn-primary" id="autoConfigBtn" onclick="autoConfigureApn()" style="margin-top: 10px;">
                                &#9889; AUTO-CONFIGURE
                            </button>
                        </div>

                        <div id="apnConnectionsList" style="margin-top: 15px;">
                            <!-- Existing connections populated by JS -->
                            <div style="color: var(--text-muted); font-size: 12px; padding: 10px 0;">
                                Loading cellular connections...
                            </div>
                        </div>

                        <div class="apn-form" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 10px; color: var(--text-secondary);">Manual APN Configuration</h4>
                            <div class="setting-row">
                                <label>Connection Name:</label>
                                <input type="text" id="apnConnectionName" class="input" value="WARHAMMER-Mobile" placeholder="Connection name">
                            </div>
                            <div class="setting-row">
                                <label>APN:</label>
                                <input type="text" id="apnName" class="input" placeholder="e.g., fast.t-mobile.com">
                            </div>
                            <div class="setting-row">
                                <label>Username (optional):</label>
                                <input type="text" id="apnUsername" class="input" placeholder="Leave blank if not required">
                            </div>
                            <div class="setting-row">
                                <label>Password (optional):</label>
                                <input type="password" id="apnPassword" class="input" placeholder="Leave blank if not required">
                            </div>
                            <div class="setting-row">
                                <label class="toggle">
                                    <input type="checkbox" id="apnAutoconnect" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">Auto-connect</span>
                                </label>
                            </div>
                            <div class="btn-group mt-10">
                                <button class="btn btn-secondary" onclick="saveApnSettings()">
                                    SAVE MANUAL APN
                                </button>
                            </div>
                            <div id="apnStatus" style="margin-top: 10px; font-size: 12px;"></div>
                        </div>
                    </div>
                </div>

                <div id="settingsDisplay" class="settings-content">
                    <div class="settings-group">
                        <h3>Theme</h3>
                        <div class="setting-row">
                            <label class="toggle">
                                <input type="checkbox" id="darkMode" checked onchange="toggleDarkMode()">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Dark Mode</span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <label class="toggle">
                                <input type="checkbox" id="animationsEnabled" checked>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Enable Animations</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="settingsSubscription" class="settings-content">
                    <div class="settings-group">
                        <h3>License Status</h3>
                        <div class="token-status-card" id="tokenStatusCard">
                            <div class="subscription-status-header">
                                <span class="subscription-status-badge" id="subscriptionBadge">ACTIVE</span>
                                <span class="subscription-tier" id="subscriptionTier">Standard</span>
                            </div>
                            <div class="subscription-details">
                                <div class="setting-row">
                                    <label>Token Expiry:</label>
                                    <span class="info-value" id="tokenExpiryDate">--</span>
                                </div>
                                <div class="setting-row">
                                    <label>Days Remaining:</label>
                                    <span class="info-value days-remaining" id="tokenDaysRemaining">--</span>
                                </div>
                                <div class="setting-row">
                                    <label>Last Synced:</label>
                                    <span class="info-value" id="tokenLastUpdated">--</span>
                                </div>
                            </div>
                            <div class="btn-group mt-10">
                                <button class="btn btn-secondary" onclick="fetchTokenExpiry()">
                                    &#8635; SYNC FROM SERVER
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for compatibility -->
                    <span id="subLicenseKey" class="hidden"></span>
                    <span id="subStartDate" class="hidden"></span>
                    <span id="subExpiryDate" class="hidden"></span>
                    <span id="subDaysRemaining" class="hidden"></span>
                    <span id="subscriptionStatusCard" class="hidden"></span>
                    <input type="hidden" id="configSubExpiry">
                    <input type="hidden" id="configTokenExpiry">
                    <input type="hidden" id="configLicenseKey">
                    <span id="tokenName" class="hidden"></span>
                    <div id="subscriptionAlertsList" class="hidden"></div>
                </div>

                <div id="settingsAbout" class="settings-content">
                    <div class="about-section">
                        <div class="about-logo">
                            <svg width="80" height="80" viewBox="0 0 100 100">
                                <rect x="20" y="15" width="60" height="25" rx="3" fill="url(#aboutHg)" stroke="#ff6b35" stroke-width="2"/>
                                <rect x="45" y="40" width="10" height="50" rx="2" fill="#3a2a1a" stroke="#ff6b35" stroke-width="1.5"/>
                                <defs><linearGradient id="aboutHg" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ff8c42"/><stop offset="100%" style="stop-color:#cc3700"/>
                                </linearGradient></defs>
                            </svg>
                        </div>
                        <h2>WARHAMMER</h2>
                        <p class="about-version">Version <span id="appVersion">{{ version }}</span></p>
                        <p class="about-desc">Network Overlay Management System</p>
                        <p class="about-copy">Secure Tactical Network Infrastructure</p>

                        <!-- System Upgrade -->
                        <div class="about-upgrade">
                            <button class="btn btn-primary upgrade-btn" id="upgradeBtn" onclick="openUpgradeModal()">
                                <span>&#11014;</span> CHECK FOR UPDATES
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <span id="confirmTitle">CONFIRM ACTION</span>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure?</p>
                <div class="btn-group">
                    <button class="btn btn-danger" id="confirmYes">CONFIRM</button>
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Peer Details Modal -->
    <div id="peerModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span>&#128101; PEER DETAILS</span>
                <button class="modal-close" onclick="closePeerModal()">&times;</button>
            </div>
            <div class="modal-body" id="peerModalContent">
                <!-- Peer details populated by JS -->
            </div>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div id="addRouteModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span>&#128739; ADD NETWORK ROUTE</span>
                <button class="modal-close" onclick="closeAddRouteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label>Network ID:</label>
                    <input type="text" id="routeNetworkId" placeholder="office-network" class="input">
                    <small style="color: var(--text-muted); font-size: 11px;">Unique identifier (lowercase, no spaces)</small>
                </div>
                <div class="form-row">
                    <label>Network CIDR:</label>
                    <input type="text" id="routeNetwork" placeholder="10.0.0.0/24" class="input">
                </div>
                <div class="form-row">
                    <label>Description:</label>
                    <input type="text" id="routeDescription" placeholder="Route description" class="input">
                </div>
                <div class="form-row">
                    <label>Peer:</label>
                    <select id="routePeer" class="input">
                        <option value="">-- Select Peer --</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Groups:</label>
                    <select id="routeGroups" class="input" multiple size="4">
                        <!-- Populated by JS -->
                    </select>
                    <small style="color: var(--text-muted); font-size: 11px;">Ctrl+click to select multiple</small>
                </div>
                <div class="form-row">
                    <label>Metric:</label>
                    <input type="number" id="routeMetric" value="9999" min="0" max="99999" class="input">
                </div>
                <div class="form-row">
                    <label class="toggle">
                        <input type="checkbox" id="routeMasquerade" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Masquerade</span>
                    </label>
                </div>
                <div class="form-row">
                    <label class="toggle">
                        <input type="checkbox" id="routeEnabled" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Enabled</span>
                    </label>
                </div>
                <div class="btn-group mt-10">
                    <button class="btn btn-primary" onclick="submitAddRoute()">ADD ROUTE</button>
                    <button class="btn btn-secondary" onclick="closeAddRouteModal()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface Config Modal -->
    <div id="interfaceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span>&#128268; INTERFACE CONFIGURATION</span>
                <button class="modal-close" onclick="closeInterfaceModal()">&times;</button>
            </div>
            <div class="modal-body" id="interfaceModalContent">
                <!-- Interface config populated by JS -->
            </div>
        </div>
    </div>

    <!-- System Upgrade Modal -->
    <div id="upgradeModal" class="modal hidden">
        <div class="modal-content upgrade-modal">
            <div class="modal-header">
                <span>&#11014; SYSTEM UPGRADE</span>
                <button class="modal-close" onclick="closeUpgradeModal()" id="upgradeModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div id="upgradeInitial">
                    <!-- Update Preview - populated by JS -->
                    <div id="upgradePreview" class="upgrade-preview">
                        <div style="color: var(--text-muted); padding: 20px; text-align: center;">
                            <div class="checking-spinner"></div>
                            <p style="margin-top: 10px;">Checking for updates...</p>
                        </div>
                    </div>

                    <!-- Upgrade Options - shown only when updates available -->
                    <div id="upgradeActions" class="hidden">
                        <p style="margin: 15px 0 10px; color: var(--text-secondary);">
                            Choose an upgrade option:
                        </p>

                        <div class="upgrade-options">
                            <div class="upgrade-option" id="uiUpgradeOption" onclick="startUpgrade('ui')">
                                <div class="upgrade-option-icon">&#9889;</div>
                                <div class="upgrade-option-info">
                                    <h4>UI Only <span class="upgrade-fast">(Fast)</span></h4>
                                    <p>Updates WARHAMMER interface only. Auto-restarts when done.</p>
                                </div>
                            </div>

                            <div class="upgrade-option" id="fullUpgradeOption" onclick="startUpgrade('full')">
                                <div class="upgrade-option-icon">&#128187;</div>
                                <div class="upgrade-option-info">
                                    <h4>Full System</h4>
                                    <p>Updates system packages + WARHAMMER. May require reboot.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Updates Message - shown when everything is up to date -->
                    <div id="noUpdatesMessage" class="hidden" style="text-align: center; padding: 20px;">
                        <span style="font-size: 40px;">&#9989;</span>
                        <h3 style="color: var(--accent-success); margin-top: 10px;">Everything is up to date!</h3>
                        <p style="color: var(--text-muted); font-size: 12px; margin-top: 10px;">No updates available at this time.</p>
                    </div>

                    <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="closeUpgradeModal()">CLOSE</button>
                </div>

                <div id="upgradeProgress" class="hidden">
                    <div class="upgrade-stage" id="upgradeStage">Initializing...</div>
                    <div class="upgrade-progress-bar">
                        <div class="upgrade-progress-fill" id="upgradeProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="upgrade-log" id="upgradeLog">
                        <!-- Log entries populated by JS -->
                    </div>
                </div>

                <div id="upgradeComplete" class="hidden">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <span style="font-size: 40px;">&#9989;</span>
                        <h3 style="color: var(--accent-success); margin-top: 10px;">Upgrade Complete</h3>
                        <p id="upgradeCompleteMsg" style="color: var(--text-muted); font-size: 12px; margin-top: 10px;"></p>
                    </div>
                    <div class="upgrade-complete-actions" id="upgradeCompleteActions">
                        <!-- Dynamically populated based on reboot required -->
                    </div>
                </div>

                <div id="upgradeFailed" class="hidden">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <span style="font-size: 40px;">&#10060;</span>
                        <h3 style="color: var(--accent-danger); margin-top: 10px;">Upgrade Failed</h3>
                        <p id="upgradeError" style="color: var(--text-muted); font-size: 12px;"></p>
                    </div>
                    <div class="upgrade-complete-actions">
                        <button class="btn btn-primary" onclick="retryUpgrade()">RETRY</button>
                        <button class="btn btn-secondary" onclick="closeUpgradeModal()">CLOSE</button>
                    </div>
                </div>

                <div id="upgradeRestarting" class="hidden">
                    <div class="restart-animation">
                        <div class="restart-spinner"></div>
                        <h3>System Restarting</h3>
                        <p>Please wait while the application restarts...</p>
                        <div class="restart-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Plugin Modal -->
    <div id="addPluginModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span>&#128230; ADD PLUGIN</span>
                <button class="modal-close" onclick="closeAddPluginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Docker Image *</label>
                    <input type="text" id="pluginImage" class="form-control" placeholder="e.g., ghcr.io/user/image:latest">
                    <small class="form-help">Full Docker image name with registry and tag</small>
                </div>
                <div class="form-group">
                    <label>Plugin Name</label>
                    <input type="text" id="pluginName" class="form-control" placeholder="Leave empty to use image name">
                </div>
                <div class="form-group">
                    <label>Network Mode</label>
                    <select id="pluginNetwork" class="form-control">
                        <option value="host">Host (recommended)</option>
                        <option value="bridge">Bridge</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Port Mappings</label>
                    <input type="text" id="pluginPorts" class="form-control" placeholder="e.g., 8080:80, 3000:3000">
                    <small class="form-help">Comma-separated host:container port pairs (optional with host network)</small>
                </div>
                <div class="form-group">
                    <label>Environment Variables</label>
                    <textarea id="pluginEnv" class="form-control" rows="3" placeholder="KEY=value&#10;ANOTHER_KEY=value"></textarea>
                    <small class="form-help">One variable per line</small>
                </div>
                <div class="form-group">
                    <label>Volume Mounts</label>
                    <textarea id="pluginVolumes" class="form-control" rows="2" placeholder="/host/path:/container/path&#10;/data:/app/data"></textarea>
                    <small class="form-help">One mount per line (host:container)</small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="addPlugin()">ADD PLUGIN</button>
                    <button class="btn btn-secondary" onclick="closeAddPluginModal()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plugin Details Modal -->
    <div id="pluginModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <span id="pluginModalTitle">&#128230; PLUGIN DETAILS</span>
                <button class="modal-close" onclick="closePluginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="pluginDetails">
                    <!-- Plugin details populated by JS -->
                </div>
                <div class="plugin-logs-section">
                    <div class="plugin-logs-header">
                        <span>Container Logs</span>
                        <button class="btn btn-xs btn-secondary" onclick="refreshPluginLogs()">Refresh</button>
                    </div>
                    <pre class="plugin-logs" id="pluginLogs">Loading logs...</pre>
                </div>
                <div class="form-actions" style="margin-top: 15px;">
                    <button class="btn btn-success" id="pluginStartBtn" onclick="controlSelectedPlugin('start')">START</button>
                    <button class="btn btn-warning" id="pluginStopBtn" onclick="controlSelectedPlugin('stop')">STOP</button>
                    <button class="btn btn-secondary" id="pluginRestartBtn" onclick="controlSelectedPlugin('restart')">RESTART</button>
                    <button class="btn btn-primary" id="pluginUpdateBtn" onclick="updateSelectedPlugin()">UPDATE</button>
                    <button class="btn btn-danger" id="pluginRemoveBtn" onclick="removeSelectedPlugin()">REMOVE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Speedtest Modal -->
    <div id="speedtestModal" class="modal hidden">
        <div class="modal-content speedtest-modal">
            <div class="modal-header">
                <span>&#128640; NETWORK SPEEDTEST</span>
                <button class="modal-close" onclick="closeSpeedtestModal()" id="speedtestModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="speedtest-target" id="speedtestTarget">
                    Testing connection to: <span id="speedtestTargetIP">--</span>
                </div>

                <div class="speedtest-gauges">
                    <div class="speedtest-gauge">
                        <div class="speedtest-gauge-circle" id="downloadGauge">
                            <svg viewBox="0 0 120 120">
                                <circle class="gauge-bg" cx="60" cy="60" r="54"/>
                                <circle class="gauge-fill download" cx="60" cy="60" r="54" id="downloadGaugeFill"/>
                            </svg>
                            <div class="speedtest-gauge-value" id="downloadSpeed">0</div>
                            <div class="speedtest-gauge-unit">Mbps</div>
                        </div>
                        <div class="speedtest-gauge-label">&#8595; DOWNLOAD</div>
                    </div>

                    <div class="speedtest-gauge">
                        <div class="speedtest-gauge-circle" id="uploadGauge">
                            <svg viewBox="0 0 120 120">
                                <circle class="gauge-bg" cx="60" cy="60" r="54"/>
                                <circle class="gauge-fill upload" cx="60" cy="60" r="54" id="uploadGaugeFill"/>
                            </svg>
                            <div class="speedtest-gauge-value" id="uploadSpeed">0</div>
                            <div class="speedtest-gauge-unit">Mbps</div>
                        </div>
                        <div class="speedtest-gauge-label">&#8593; UPLOAD</div>
                    </div>
                </div>

                <div class="speedtest-progress">
                    <div class="speedtest-progress-bar">
                        <div class="speedtest-progress-fill" id="speedtestProgressFill"></div>
                    </div>
                    <div class="speedtest-status" id="speedtestStatus">Initializing...</div>
                </div>

                <div class="speedtest-results hidden" id="speedtestResults">
                    <div class="speedtest-result-row">
                        <span class="result-label">Data Transferred:</span>
                        <span class="result-value" id="resultDataTransferred">--</span>
                    </div>
                    <div class="speedtest-result-row">
                        <span class="result-label">Retransmits:</span>
                        <span class="result-value" id="resultRetransmits">--</span>
                    </div>
                    <div class="speedtest-result-row">
                        <span class="result-label">Test Duration:</span>
                        <span class="result-value">10 seconds</span>
                    </div>
                </div>

                <div class="speedtest-error hidden" id="speedtestError">
                    <span style="color: var(--accent-danger);">&#10060;</span>
                    <span id="speedtestErrorMsg"></span>
                </div>

                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeSpeedtestModal()">CLOSE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Peer Context Menu -->
    <div id="peerContextMenu" class="context-menu hidden">
        <div class="context-menu-item" onclick="runSpeedtest()">
            <span>&#128640;</span> Run Speedtest
        </div>
        <div class="context-menu-item" onclick="showPeerDetailsFromContext()">
            <span>&#128269;</span> View Details
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Initialize with server-provided config
        const CONFIG = {
            mapboxToken: '{{ mapbox_token }}',
            warhammerDomain: '{{ warhammer_domain }}',
            hostname: '{{ warhammer_name }}'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initApp(CONFIG);
        });
    </script>
</body>
</html>
